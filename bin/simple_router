#!/usr/bin/env ruby

require 'rubygems'
require 'bundler'
Bundler.setup :default

require 'gli'
require 'trema'

# patch_panel command
module SimpleRouterApp
  extend GLI::App

  desc 'Dump the routing table.'
  command :dump_routing_tb do |c|
    c.desc 'Location to find socket files'
    c.flag [:S, :socket_dir], default_value: Trema::DEFAULT_SOCKET_DIR

    c.action do |_global_options, options, args|
      puts Trema.trema_process('SimpleRouter', options[:socket_dir]).controller.dump_routing_tb()
    end
  end

  desc 'Add an entry to the routing table.'
  command :add_entry2routing_tb do |c|
    c.desc 'Location to find socket files'
    c.flag [:S, :socket_dir], default_value: Trema::DEFAULT_SOCKET_DIR

    c.action do |_global_options, options, args|
      dest = args[0]
      netmask_len = args[1].to_i
      next_hop = args[2]
      Trema.trema_process('SimpleRouter', options[:socket_dir]).controller.add_entry2routing_tb(dest, netmask_len, next_hop)
    end
  end

  desc 'Delete an entry to the routing table.'
  command :del_entry2routing_tb do |c|
    c.desc 'Location to find socket files'
    c.flag [:S, :socket_dir], default_value: Trema::DEFAULT_SOCKET_DIR

    c.action do |_global_options, options, args|
      dest = args[0]
      netmask_len = args[1].to_i
      Trema.trema_process('SimpleRouter', options[:socket_dir]).controller.del_entry2routing_tb(dest, netmask_len)
    end
  end

  desc 'Dump interfece.'
  command :dump_interface do |c|
    c.desc 'Location to find socket files'
    c.flag [:S, :socket_dir], default_value: Trema::DEFAULT_SOCKET_DIR

    c.action do |_global_options, options, args|
      puts Trema.trema_process('SimpleRouter', options[:socket_dir]).controller.dump_interface()
    end
  end
  
  desc 'Find interface.'
  command :find_interface do |c|
    c.desc 'Location to find socket files'
    c.flag [:S, :socket_dir], default_value: Trema::DEFAULT_SOCKET_DIR
    c.flag [:port]
    c.flag [:mac]
    c.flag [:ip]
    
    c.action do |_global_options, options, args|
      port = options[:port].to_i
      mac = options[:mac]
      ip = options[:ip]
      puts Trema.trema_process('SimpleRouter', options[:socket_dir]).controller.find_interface(port, mac, ip)
    end
  end
  
  exit run(ARGV)
end
